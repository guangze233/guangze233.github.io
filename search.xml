<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Blender 黑体骑士Ⅱ</title>
    <url>/2024/02/28/Blender-%E9%BB%91%E4%BD%93%E9%AA%91%E5%A3%AB%E2%85%A1/</url>
    <content><![CDATA[<p>Blender 练习案例</p>
<span id="more"></span>

<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="氮化镓充电器建模"><a href="#氮化镓充电器建模" class="headerlink" title="氮化镓充电器建模"></a>氮化镓充电器建模</h3><img src="/2024/02/28/Blender-%E9%BB%91%E4%BD%93%E9%AA%91%E5%A3%AB%E2%85%A1/%E6%B0%AE%E5%8C%96%E9%95%93%E5%85%85%E7%94%B5%E5%99%A8%E5%BB%BA%E6%A8%A1.png" class="" title="氮化镓充电器建模">

<h3 id="氮化镓充电器PRO"><a href="#氮化镓充电器PRO" class="headerlink" title="氮化镓充电器PRO"></a>氮化镓充电器PRO</h3><img src="/2024/02/28/Blender-%E9%BB%91%E4%BD%93%E9%AA%91%E5%A3%AB%E2%85%A1/%E6%B0%AE%E5%8C%96%E9%95%93%E5%85%85%E7%94%B5%E5%99%A8PRO.png" class="" title="氮化镓充电器PRO">

<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ol>
<li><a href="https://www.bilibili.com/video/BV1zh411Y7LX?p=29&spm_id_from=pageDriver&vd_source=1e15750346a6b797fe55bee7e478af4c">【合集8.21已更新93话】Blender 2.9-3.4黑铁骑士Ⅱ系统零基础入门教程(持续更新+中文字幕+普通话+不敷衍+义务教育+案例+学习)</a></li>
</ol>
]]></content>
      <categories>
        <category>Blender</category>
      </categories>
  </entry>
  <entry>
    <title>图片占位符</title>
    <url>/2023/09/12/%E5%9B%BE%E7%89%87%E5%8D%A0%E4%BD%8D%E7%AC%A6/</url>
    <content><![CDATA[<p>需求：tinymce 编辑器中需要一个图片占位符，上面展示一些配置项，有后端根据配置项完成图片替换，前端可双击弹框修改配置项。</p>
<span id="more"></span>

<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol>
<li>绘制文字：使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/fillText">CanvasRenderingContext2.fillText()</a> 绘制文本，使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/measureText">CanvasRenderingContext2D.measureText()</a> 来判断一行长文字何时换行展示。</li>
<li>保存配置项数据：使用 data-json 自定义属性保存配置项，前端根据 data-json <strong>动态生成</strong>图片占位符的 base64 替换页面中图片占位符的 src 属性；后端可根据 data-json 生成真实数据，或修改图片占位符。</li>
<li>双击修改：监听双击事件，过滤图片占位符，从 data-json 中取出数据回填到弹框中；每个图片占位符绑定一个 mceId，用于修改时回填配置项数据和重新生成 base64。</li>
</ol>
<h2 id="文本占位符"><a href="#文本占位符" class="headerlink" title="文本占位符"></a>文本占位符</h2><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>用户在弹框中选择选项，确认后将在 tinymce 编辑器中插入一张图片占位符，上面展示刚才选择的选项，有后端根据配置项完成图片替换，前端可双击弹框修改配置项。</p>
<p>图片占位符上展示”标题” 和一行文字。例如 <em>@{xxx/yyy/zzz}</em></p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>参考 <a href="https://www.zhangxinxu.com/wordpress/2018/02/canvas-text-break-line-letter-spacing-vertical/">canvas 文本绘制自动换行、字间距、竖排等实现</a>：将文本分割为字符串，逐渐加字并测量长度，超过指定宽度时换行绘制。</p>
<blockquote>
<p>写的过程中发现 MDN fillText 的中文翻译有歧义：<a href="https://github.com/mdn/translated-content/issues/14860">fillText 参数 y 的中文描述歧义</a>。<strong>good first issue</strong> 参与大型开源项目了，属于是 : )</p>
</blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * @description 文字转Base64
 * @param &#123;*&#125; content 文字
 * @param &#123;*&#125; width 生成图片的宽度
 * @param &#123;*&#125; height 生成图片的高度
 * @returns base64
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">text2img</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> _options <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">635</span><span class="token punctuation">,</span> <span class="token comment">// px</span>
    <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">152</span><span class="token punctuation">,</span> <span class="token comment">//px</span>
    <span class="token literal-property property">fontSize</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token comment">//px</span>
    <span class="token literal-property property">fontColor</span><span class="token operator">:</span> <span class="token string">"#409EFF"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> <span class="token string">"serif"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">"#F4F4F5"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"【xx统计图】"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">imgType</span><span class="token operator">:</span> <span class="token string">"image/webp"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">encoderOptions</span><span class="token operator">:</span> <span class="token number">0.6</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>options<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> _options<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> _options<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// background</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>_options<span class="token punctuation">.</span>backgroundColor<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// font</span>
  ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>_options<span class="token punctuation">.</span>fontSize<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">px </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>_options<span class="token punctuation">.</span>fontFamily<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>_options<span class="token punctuation">.</span>fontColor<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  <span class="token comment">// calc number of words per line</span>
  <span class="token keyword">let</span> wordsPerLine <span class="token operator">=</span> content<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">const</span> charList <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> charList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> text <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">measureText</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">.</span>width <span class="token operator">>=</span> _options<span class="token punctuation">.</span>width <span class="token operator">-</span> _options<span class="token punctuation">.</span>fontSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      wordsPerLine <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// split content into lines</span>
  <span class="token keyword">const</span> lines <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>length <span class="token operator">/</span> wordsPerLine<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>length <span class="token operator">/</span> wordsPerLine<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      lines<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i <span class="token operator">*</span> wordsPerLine<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      lines<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i <span class="token operator">*</span> wordsPerLine<span class="token punctuation">,</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> wordsPerLine<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// draw title</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_options<span class="token punctuation">.</span>title<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bold </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>_options<span class="token punctuation">.</span>fontSize<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">px </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>_options<span class="token punctuation">.</span>fontFamily<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>
      _options<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
      <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token number">10</span> <span class="token operator">+</span> _options<span class="token punctuation">.</span>fontSize<span class="token punctuation">,</span>
      _options<span class="token punctuation">.</span>width <span class="token operator">-</span> _options<span class="token punctuation">.</span>fontSize
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>_options<span class="token punctuation">.</span>fontSize<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">px </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>_options<span class="token punctuation">.</span>fontFamily<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token comment">// draw content</span>
  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lines<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> text <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">measureText</span><span class="token punctuation">(</span>lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    x <span class="token operator">=</span> canvas<span class="token punctuation">.</span>width <span class="token operator">>=</span> text<span class="token punctuation">.</span>width <span class="token operator">?</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width <span class="token operator">-</span> text<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">const</span> lineMarginBottom <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> linesHeight <span class="token operator">=</span> <span class="token punctuation">(</span>_options<span class="token punctuation">.</span>fontSize <span class="token operator">+</span> lineMarginBottom<span class="token punctuation">)</span> <span class="token operator">*</span> lines<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>height <span class="token operator">-</span> linesHeight<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> _options<span class="token punctuation">.</span>fontSize<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> line <span class="token operator">=</span> lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>
      line<span class="token punctuation">,</span>
      i <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> x <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      y <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token punctuation">(</span>_options<span class="token punctuation">.</span>fontSize <span class="token operator">+</span> lineMarginBottom<span class="token punctuation">)</span><span class="token punctuation">,</span>
      _options<span class="token punctuation">.</span>width <span class="token operator">-</span> _options<span class="token punctuation">.</span>fontSize
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> canvas
    <span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span>_options<span class="token punctuation">.</span>imgType<span class="token punctuation">,</span> _options<span class="token punctuation">.</span>encoderOptions<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="粘贴占位符"><a href="#粘贴占位符" class="headerlink" title="粘贴占位符"></a>粘贴占位符</h3><p>场景: 用户可能会复制、剪切、粘贴生成的图片占位符，若直接复制粘贴，tinymce 中会有两个一样的 mceId，无法完成双击修改配置项。</p>
<p>万幸！TinyMce 提供了粘贴处理事件 <a href="https://www.tiny.cloud/docs/tinymce/6/copy-and-paste/#paste_postprocess">paste_postprocess</a>，在这里检查粘贴的 mceId 是否已存在，已存在则更新。更巧的是，此时 tinymce 内容是复制/剪切后的，即剪切（ctrl+x）时原内容已去除了，直接粘贴即可。</p>
<blockquote>
<p><strong>paste_postprocess</strong><br>This option enables you to modify the pasted content before it gets inserted into the editor, but after it’s been parsed into a DOM structure.</p>
</blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** 粘贴事件：粘贴的元素id唯一 */</span>
<span class="token keyword">async</span> <span class="token function">onPastePostprocess</span><span class="token punctuation">(</span><span class="token parameter">editor<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> args<span class="token punctuation">.</span>node
  <span class="token comment">// 去除重复id</span>
    <span class="token keyword">const</span> mceIdElementList <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'[data-mce-id]'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mceIdElementList <span class="token operator">&amp;&amp;</span> mceIdElementList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> currentTimestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      mceIdElementList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> newMceId <span class="token operator">=</span> TinyUtil<span class="token punctuation">.</span><span class="token function">getNewMecId</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>mceId<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>currentTimestamp<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>index<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          e<span class="token punctuation">.</span>id <span class="token operator">=</span> e<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>mceId <span class="token operator">=</span> newMceId
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** 业务工具 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TinyUtil</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">static</span> <span class="token function">getNewMecId</span><span class="token punctuation">(</span><span class="token parameter">oldMceId<span class="token punctuation">,</span> newUuid</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> idComponents <span class="token operator">=</span> oldMceId<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
    idComponents<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> newUuid
    <span class="token keyword">return</span> idComponents<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="一行-n-个"><a href="#一行-n-个" class="headerlink" title="一行 n 个"></a>一行 n 个</h3><p>需求变了：用户在系统弹框中选择了一些配置项，请求<strong>后端接口返回一系列配置项</strong>，要求展示这些图片占位符并且可以自定义一行展示几个（一行可选个数：1、2、3、4）。</p>
<ol>
<li>批量生成图片占位符：循环生成即可。</li>
<li>一行 n 个：这些图片占位符外层套一层 grid 布局；由于 tinymce 宽度是确定的，可根据每行展示个数确认图片占位符的宽度，并修改字体大小以 <del>美观</del> 不丑陋。</li>
</ol>
<blockquote>
<p>外层的 grid 布局会影响到输入正常内容，如在 grid 内部回车换行后输入新内容，则新行也存在 grid 样式，十分冗余难受。<br>可监听 tinymce 的 <a href="https://www.tiny.cloud/docs/tinymce/6/events/#editor-core-events">NewBlock</a> 事件，以处理新行样式。</p>
</blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// grid 样式</span>
<span class="token keyword">const</span> wrapper <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span>
wrapper<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'img-holder-grid-wrapper'</span><span class="token punctuation">)</span>
wrapper<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'grid'</span>
wrapper<span class="token punctuation">.</span>style<span class="token punctuation">.</span>gridTemplateColumns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>placeholder<span class="token punctuation">.</span>columns<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'1fr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
wrapper<span class="token punctuation">.</span>style<span class="token punctuation">.</span>gap <span class="token operator">=</span> <span class="token string">'5px'</span>
wrapper<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'lineWrap'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 图片大小</span>
<span class="token literal-property property">width</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">635</span> <span class="token operator">/</span> columns<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token literal-property property">height</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">152</span> <span class="token operator">-</span> <span class="token punctuation">(</span>columns <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token literal-property property">fontSize</span><span class="token operator">:</span> <span class="token number">16</span> <span class="token operator">-</span> <span class="token punctuation">(</span>columns <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="表单占位符"><a href="#表单占位符" class="headerlink" title="表单占位符"></a>表单占位符</h2><h3 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h3><p>过了几天，领导想要在图片占位符上展示更多的信息，最好能把自定义弹框里的选项都展示出来，文字拼接展示太丑了。</p>
<h3 id="设计与实现"><a href="#设计与实现" class="headerlink" title="设计与实现"></a>设计与实现</h3><p>已经不想改需求了，恰好发现项目中在用的第三方库 <a href="http://fabricjs.com/">Fabric.js</a> 有文字换行功能。太好了！拿来就用！！！</p>
<p>让后端把配置项整理成数组形式 [{label, content}, {label, content}]</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>fabric<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'fabric'</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TinyUtil</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/** 生成图片占位符 */</span>
  <span class="token keyword">static</span> <span class="token function">genImgHolderByForm</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span>caption<span class="token punctuation">,</span> formCfg<span class="token punctuation">,</span> columns <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
    img<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'img-holder'</span><span class="token punctuation">)</span>
    img<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'mce-img-holder'</span><span class="token punctuation">)</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> TinyUtil<span class="token punctuation">.</span><span class="token function">form2img</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> formCfg <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>formCfg<span class="token punctuation">)</span> <span class="token operator">:</span> formCfg<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">caption</span><span class="token operator">:</span> caption<span class="token punctuation">,</span>
      <span class="token literal-property property">imgWidth</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">635</span> <span class="token operator">/</span> columns<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">imgHeight</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">152</span> <span class="token operator">-</span> <span class="token punctuation">(</span>columns <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">fontSize</span><span class="token operator">:</span> <span class="token number">16</span> <span class="token operator">-</span> <span class="token punctuation">(</span>columns <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> img
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/** 图片表单 */</span>
  <span class="token keyword">static</span> <span class="token function">form2img</span><span class="token punctuation">(</span><span class="token parameter">formCfg<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">imgWidth</span><span class="token operator">:</span> params<span class="token operator">?.</span>imgWidth <span class="token operator">||</span> <span class="token number">300</span><span class="token punctuation">,</span>
      <span class="token literal-property property">imgHeight</span><span class="token operator">:</span> params<span class="token operator">?.</span>imgHeight <span class="token operator">||</span> <span class="token number">150</span><span class="token punctuation">,</span>
      <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> <span class="token string">'serif'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">fontSize</span><span class="token operator">:</span> params<span class="token operator">?.</span>fontSize <span class="token operator">||</span> <span class="token number">14</span><span class="token punctuation">,</span>
      <span class="token literal-property property">fontColor</span><span class="token operator">:</span> params<span class="token operator">?.</span>fontColor <span class="token operator">||</span> <span class="token string">'#409EFF'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> params<span class="token operator">?.</span>backgroundColor <span class="token operator">||</span> <span class="token string">'#F4F4F5'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">padding</span><span class="token operator">:</span> params<span class="token punctuation">.</span>padding <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token literal-property property">labelWidth</span><span class="token operator">:</span> <span class="token punctuation">(</span>params<span class="token operator">?.</span>fontSize <span class="token operator">||</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fabric<span class="token punctuation">.</span>Canvas</span><span class="token punctuation">(</span><span class="token string">'canvasBox'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> options<span class="token punctuation">.</span>imgWidth<span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> options<span class="token punctuation">.</span>imgHeight<span class="token punctuation">,</span>
      <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> options<span class="token punctuation">.</span>backgroundColor<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> nextTop <span class="token operator">=</span> <span class="token number">20</span>
    <span class="token comment">// draw caption</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token operator">?.</span>caption<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> caption <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fabric<span class="token punctuation">.</span>Text</span><span class="token punctuation">(</span>params<span class="token operator">?.</span>caption<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontFamily<span class="token punctuation">,</span>
        <span class="token literal-property property">fontSize</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontSize<span class="token punctuation">,</span>
        <span class="token literal-property property">fontWeight</span><span class="token operator">:</span> <span class="token string">'bold'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">fill</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontColor<span class="token punctuation">,</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      canvas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>caption<span class="token punctuation">)</span>
      nextTop <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">+</span> caption<span class="token punctuation">.</span>height <span class="token operator">+</span> <span class="token number">10</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// get max label width</span>
    <span class="token keyword">let</span> labelWidth <span class="token operator">=</span> options<span class="token punctuation">.</span>labelWidth
    formCfg<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> measureTabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fabric<span class="token punctuation">.</span>Textbox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>label<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">：</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> options<span class="token punctuation">.</span>padding<span class="token punctuation">,</span>
        <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontFamily<span class="token punctuation">,</span>
        <span class="token literal-property property">fontSize</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontSize<span class="token punctuation">,</span>
        <span class="token literal-property property">fill</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontColor<span class="token punctuation">,</span>
        <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">'right'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> nextTop<span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> labelWidth<span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>labelWidth <span class="token operator">&lt;</span> measureTabel<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        labelWidth <span class="token operator">=</span> measureTabel<span class="token punctuation">.</span>width
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token comment">// draw from</span>
    formCfg<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> itemLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fabric<span class="token punctuation">.</span>Textbox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>label<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">：</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> options<span class="token punctuation">.</span>padding<span class="token punctuation">,</span>
        <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontFamily<span class="token punctuation">,</span>
        <span class="token literal-property property">fontSize</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontSize<span class="token punctuation">,</span>
        <span class="token literal-property property">fill</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontColor<span class="token punctuation">,</span>
        <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">'right'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> nextTop<span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> labelWidth<span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> itemContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fabric<span class="token punctuation">.</span>Textbox</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> options<span class="token punctuation">.</span>padding <span class="token operator">+</span> labelWidth<span class="token punctuation">,</span>
        <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontFamily<span class="token punctuation">,</span>
        <span class="token literal-property property">fontSize</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontSize<span class="token punctuation">,</span>
        <span class="token literal-property property">fill</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontColor<span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> nextTop<span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> canvas<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> options<span class="token punctuation">.</span>padding <span class="token operator">-</span> labelWidth<span class="token punctuation">,</span>
        <span class="token literal-property property">splitByGrapheme</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 自动换行</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      nextTop <span class="token operator">+=</span> itemContent<span class="token punctuation">.</span>height <span class="token operator">+</span> <span class="token number">10</span>
      canvas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>itemLabel<span class="token punctuation">)</span>
      canvas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>itemContent<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token comment">// adjust img height</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextTop <span class="token operator">></span> options<span class="token punctuation">.</span>imgHeight<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      options<span class="token punctuation">.</span>imgHeight <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>nextTop <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span>
      canvas<span class="token punctuation">.</span><span class="token function">setHeight</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>imgHeight<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="异步优化"><a href="#异步优化" class="headerlink" title="异步优化"></a>异步优化</h3><h4 id="前置场景"><a href="#前置场景" class="headerlink" title="前置场景"></a>前置场景</h4><p>系统提供了文章预览功能，展示一系列的文章标题，鼠标悬浮时展示文章内容（文章内放入图片也要展示）。<br><del>后端说提供不了缩略图，而且这个功能很重要，完成不了领导就不高兴，领导不高兴项目就完蛋了，项目没有回款的话公司就倒闭了，所以无论如何前端自己想办法完成。</del><br>方案是：前端直接 v-html 展示算了，正好 tinymce 保存的就是 html 格式，请求到数据后生成图片占位符再塞到 v-html 中。</p>
<p>总感觉哪里不对，但是能用。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 请求文章列表</span>
<span class="token keyword">let</span> tempList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token function">list</span><span class="token punctuation">(</span>queryData<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> tempList <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    tempList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">...</span>item<span class="token punctuation">,</span>
        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderContentImgHolder</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token comment">// 存放 html 字符串</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">renderContentImgHolder</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
  div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> item<span class="token punctuation">.</span>content
  <span class="token keyword">const</span> imgs <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'.mce-img-holder'</span><span class="token punctuation">)</span>
  imgs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">?.</span>dataset<span class="token operator">?.</span>placeholder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> img <span class="token operator">=</span> TinyUtil<span class="token punctuation">.</span><span class="token function">genImgHolderByForm</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>placeholder<span class="token punctuation">)</span><span class="token punctuation">)</span>
      e<span class="token punctuation">.</span>src <span class="token operator">=</span> img<span class="token punctuation">.</span>src
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> div<span class="token punctuation">.</span>innerHTML
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="异步优化-1"><a href="#异步优化-1" class="headerlink" title="异步优化"></a>异步优化</h4><p>不出意外地出意外了，有几篇文章插入了上百个图片占位符，回显单个文章有卡顿感，展示文章缩略图时甚至能卡黑屏。</p>
<p>测试项目中3.2方案 191 张图片占位符用了 7233ms，cpu 一下子就满了，怪离谱的。</p>
<p>那就改成异步的：加载时先展示空白图片占位符（生成一次url, 不耗时），在 worker 线程中批量生成图片占位符（避免页面卡顿），在主线程中接收占位符的 url 并回填（使用 mceId 查找元素，替换 src）。遗憾的是，Fabric 不支持在 worker 中，只能自己用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/OffscreenCanvas">OffscreenCanvas</a> 写，闻者伤心，听者落泪。</p>
<p>页面中将数据发送给 worker 处理，监听自定义事件处理数据回填即可。</p>
<p>下附生成占位符的性能对比 (100 张图片)</p>
<table>
<thead>
<tr>
<th>方案</th>
<th>轮次</th>
<th>耗时（ms）</th>
<th>平均耗时（ms）</th>
</tr>
</thead>
<tbody><tr>
<td>OffscreenCanvas （await）</td>
<td>1</td>
<td>519</td>
<td>538</td>
</tr>
<tr>
<td>…</td>
<td>2</td>
<td>547</td>
<td></td>
</tr>
<tr>
<td>…</td>
<td>3</td>
<td>549</td>
<td></td>
</tr>
<tr>
<td>OffscreenCanvas （promise）</td>
<td>1</td>
<td>510</td>
<td>513</td>
</tr>
<tr>
<td>…</td>
<td>2</td>
<td>518</td>
<td></td>
</tr>
<tr>
<td>…</td>
<td>3</td>
<td>513</td>
<td></td>
</tr>
<tr>
<td>Canvas</td>
<td>1</td>
<td>419</td>
<td>421</td>
</tr>
<tr>
<td>…</td>
<td>2</td>
<td>422</td>
<td></td>
</tr>
<tr>
<td>…</td>
<td>3</td>
<td>422</td>
<td></td>
</tr>
<tr>
<td>fabric</td>
<td>1</td>
<td>1589</td>
<td>1571</td>
</tr>
<tr>
<td>…</td>
<td>2</td>
<td>1541</td>
<td></td>
</tr>
<tr>
<td>…</td>
<td>3</td>
<td>1584</td>
<td></td>
</tr>
</tbody></table>
<p><strong>测试程序</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> TinyCanvas <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"./../lib/main"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> fabric <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"fabric"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">FORM_ITEMS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">label</span><span class="token operator">:</span> <span class="token string">"活动名称"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span>
      <span class="token string">"活动名称活动名称活动名称活动名称活动名称活动名称活动名称活动名称活动名称"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">label</span><span class="token operator">:</span> <span class="token string">"活动区域"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">"区域一"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">label</span><span class="token operator">:</span> <span class="token string">"活动时间"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">"2023-09-01 ~ 2023-09-02"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">label</span><span class="token operator">:</span> <span class="token string">"活动性质"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">"美食/餐厅线上活动、地推活动、线下主题活动"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">label</span><span class="token operator">:</span> <span class="token string">"特殊资源"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">"线上品牌商赞助、线下场地免费"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">label</span><span class="token operator">:</span> <span class="token string">"备注"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">"备注"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">btn</span><span class="token operator">:</span> HTMLButtonElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#btn"</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
btn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// testOffscreenCanvas();</span>
  <span class="token comment">// await testOffscreenCanvasAwait();</span>
  <span class="token comment">// testCanvas();</span>
  <span class="token function">testFabric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">testOffscreenCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> timeCalc <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">offscrrenCanvas</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> imgNum <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> formItems <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">FORM_ITEMS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imgNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    formItems<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"备注"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TinyCanvas</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">600</span><span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">renderForm</span><span class="token punctuation">(</span><span class="token string">"【xxx图】"</span><span class="token punctuation">,</span> formItems<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      count<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> imgNum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        timeCalc<span class="token punctuation">.</span>offscrrenCanvas <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>timeCalc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testOffscreenCanvasAwait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> timeCalc <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">offscrrenCanvas</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> imgNum <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> formItems <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">FORM_ITEMS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imgNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    formItems<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"备注"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TinyCanvas</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">600</span><span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> canvas<span class="token punctuation">.</span><span class="token function">renderForm</span><span class="token punctuation">(</span><span class="token string">"【xxx图】"</span><span class="token punctuation">,</span> formItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  timeCalc<span class="token punctuation">.</span>offscrrenCanvas <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>timeCalc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">testCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> timeCalc <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">offscrrenCanvas</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> imgNum <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> formItems <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">FORM_ITEMS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imgNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    formItems<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"备注"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TinyCanvas</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">600</span><span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
      <span class="token literal-property property">isOffscreen</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">renderFormSync</span><span class="token punctuation">(</span><span class="token string">"【xxx图】"</span><span class="token punctuation">,</span> formItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  timeCalc<span class="token punctuation">.</span>offscrrenCanvas <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>timeCalc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">testFabric</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> timeCalc <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">fabric</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">imgWidth</span><span class="token operator">:</span> <span class="token number">600</span><span class="token punctuation">,</span>
    <span class="token literal-property property">imgHeight</span><span class="token operator">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
    <span class="token literal-property property">caption</span><span class="token operator">:</span> <span class="token string">"【xxx图】"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> imgNum <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> formItems <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">FORM_ITEMS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imgNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    formItems<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"备注"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">form2img</span><span class="token punctuation">(</span>formItems<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  timeCalc<span class="token punctuation">.</span>fabric <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span>timeCalc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/** 图片表单 */</span>
<span class="token keyword">function</span> <span class="token function">form2img</span><span class="token punctuation">(</span><span class="token parameter">formCfg<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">imgWidth</span><span class="token operator">:</span> params<span class="token operator">?.</span>imgWidth <span class="token operator">||</span> <span class="token number">300</span><span class="token punctuation">,</span>
    <span class="token literal-property property">imgHeight</span><span class="token operator">:</span> params<span class="token operator">?.</span>imgHeight <span class="token operator">||</span> <span class="token number">150</span><span class="token punctuation">,</span>
    <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> <span class="token string">"serif"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">fontSize</span><span class="token operator">:</span> params<span class="token operator">?.</span>fontSize <span class="token operator">||</span> <span class="token number">14</span><span class="token punctuation">,</span>
    <span class="token literal-property property">fontColor</span><span class="token operator">:</span> params<span class="token operator">?.</span>fontColor <span class="token operator">||</span> <span class="token string">"#409EFF"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> params<span class="token operator">?.</span>backgroundColor <span class="token operator">||</span> <span class="token string">"#F4F4F5"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">padding</span><span class="token operator">:</span> params<span class="token punctuation">.</span>padding <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token literal-property property">labelWidth</span><span class="token operator">:</span> <span class="token punctuation">(</span>params<span class="token operator">?.</span>fontSize <span class="token operator">||</span> <span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fabric<span class="token punctuation">.</span>Canvas</span><span class="token punctuation">(</span><span class="token string">"canvasBox"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">width</span><span class="token operator">:</span> options<span class="token punctuation">.</span>imgWidth<span class="token punctuation">,</span>
    <span class="token literal-property property">height</span><span class="token operator">:</span> options<span class="token punctuation">.</span>imgHeight<span class="token punctuation">,</span>
    <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> options<span class="token punctuation">.</span>backgroundColor<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextTop <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
  <span class="token comment">// draw caption</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token operator">?.</span>caption<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> caption <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fabric<span class="token punctuation">.</span>Text</span><span class="token punctuation">(</span>params<span class="token operator">?.</span>caption<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontFamily<span class="token punctuation">,</span>
      <span class="token literal-property property">fontSize</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontSize<span class="token punctuation">,</span>
      <span class="token literal-property property">fontWeight</span><span class="token operator">:</span> <span class="token string">"bold"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">fill</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontColor<span class="token punctuation">,</span>
      <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>caption<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nextTop <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">+</span> caption<span class="token punctuation">.</span>height <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// get max label width</span>
  <span class="token keyword">let</span> labelWidth <span class="token operator">=</span> options<span class="token punctuation">.</span>labelWidth<span class="token punctuation">;</span>
  formCfg<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> measureTabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fabric<span class="token punctuation">.</span>Textbox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>label<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">：</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">left</span><span class="token operator">:</span> options<span class="token punctuation">.</span>padding<span class="token punctuation">,</span>
      <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontFamily<span class="token punctuation">,</span>
      <span class="token literal-property property">fontSize</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontSize<span class="token punctuation">,</span>
      <span class="token literal-property property">fill</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontColor<span class="token punctuation">,</span>
      <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">"right"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">top</span><span class="token operator">:</span> nextTop<span class="token punctuation">,</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> labelWidth<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>labelWidth <span class="token operator">&lt;</span> measureTabel<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      labelWidth <span class="token operator">=</span> measureTabel<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// draw from</span>
  formCfg<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> itemLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fabric<span class="token punctuation">.</span>Textbox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>item<span class="token punctuation">.</span>label<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">：</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">left</span><span class="token operator">:</span> options<span class="token punctuation">.</span>padding<span class="token punctuation">,</span>
      <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontFamily<span class="token punctuation">,</span>
      <span class="token literal-property property">fontSize</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontSize<span class="token punctuation">,</span>
      <span class="token literal-property property">fill</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontColor<span class="token punctuation">,</span>
      <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">"right"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">top</span><span class="token operator">:</span> nextTop<span class="token punctuation">,</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> labelWidth<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> itemContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fabric<span class="token punctuation">.</span>Textbox</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">left</span><span class="token operator">:</span> options<span class="token punctuation">.</span>padding <span class="token operator">+</span> labelWidth<span class="token punctuation">,</span>
      <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontFamily<span class="token punctuation">,</span>
      <span class="token literal-property property">fontSize</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontSize<span class="token punctuation">,</span>
      <span class="token literal-property property">fill</span><span class="token operator">:</span> options<span class="token punctuation">.</span>fontColor<span class="token punctuation">,</span>
      <span class="token literal-property property">top</span><span class="token operator">:</span> nextTop<span class="token punctuation">,</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> canvas<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> options<span class="token punctuation">.</span>padding <span class="token operator">-</span> labelWidth<span class="token punctuation">,</span>
      <span class="token literal-property property">splitByGrapheme</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 自动换行</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nextTop <span class="token operator">+=</span> itemContent<span class="token punctuation">.</span>height <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>itemLabel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>itemContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// adjust img height</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextTop <span class="token operator">></span> options<span class="token punctuation">.</span>imgHeight<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    options<span class="token punctuation">.</span>imgHeight <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>nextTop <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">setHeight</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>imgHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="图片表单"><a href="#图片表单" class="headerlink" title="图片表单"></a>图片表单</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">interface</span> <span class="token class-name">ITinyCanvasOptions</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/**
   * 图片宽度
   */</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 图片高度
   */</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 是否离屏渲染
   */</span>
  isOffscreen<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 背景色
   */</span>
  backgroundColor<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> CanvasGradient <span class="token operator">|</span> CanvasPattern<span class="token punctuation">;</span>
  <span class="token comment">/**
   * base64参数
   */</span>
  blobOptions<span class="token operator">?</span><span class="token operator">:</span> IBlobOptions<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 字号
   */</span>
  fontSize<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 字体颜色
   */</span>
  fontColor<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 字体
   */</span>
  fontFamily<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">interface</span> <span class="token class-name">IBlobOptions</span> <span class="token punctuation">&#123;</span>
  type<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  quality<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">interface</span> <span class="token class-name">IFormItem</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">label</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token literal-property property">content</span><span class="token operator">:</span> string <span class="token operator">|</span> number <span class="token operator">|</span> boolean<span class="token punctuation">;</span>
  labelWidth<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
  contentHeight<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">interface</span> <span class="token class-name">ITextOptions</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">left</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token literal-property property">top</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">const</span> <span class="token literal-property property">DefaultTinyCanvasOptions</span><span class="token operator">:</span> ITinyCanvasOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
  <span class="token literal-property property">isOffscreen</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">"#F4F4F5"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">fontSize</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
  <span class="token literal-property property">fontColor</span><span class="token operator">:</span> <span class="token string">"#409EFF"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> <span class="token string">"serif"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TinyCanvas</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token literal-property property">canvas</span><span class="token operator">:</span> OffscreenCanvas <span class="token operator">|</span> HTMLCanvasElement<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token literal-property property">ctx</span><span class="token operator">:</span>
    <span class="token operator">|</span> OffscreenCanvasRenderingContext2D
    <span class="token operator">|</span> CanvasRenderingContext2D
    <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token literal-property property">options</span><span class="token operator">:</span> ITinyCanvasOptions<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">?</span><span class="token operator">:</span> ITinyCanvasOptions</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>DefaultTinyCanvasOptions<span class="token punctuation">,</span> <span class="token operator">...</span>options <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canvas <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>isOffscreen
      <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">OffscreenCanvas</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
      <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"canvas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">renderForm</span><span class="token punctuation">(</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
    <span class="token literal-property property">formItems</span><span class="token operator">:</span> IFormItem<span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> imgHeight<span class="token punctuation">,</span> labelWidth <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drawFrom</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> formItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>imgHeight <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> imgHeight<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drawFrom</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> formItems<span class="token punctuation">,</span> labelWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>isOffscreen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>canvas <span class="token keyword">as</span> OffscreenCanvas<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertToBlob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> fileReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileReader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>fileReader<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        fileReader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>canvas <span class="token keyword">as</span> HTMLCanvasElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">public</span> <span class="token function">renderFormSync</span><span class="token punctuation">(</span>title<span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">formItems</span><span class="token operator">:</span> IFormItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>isOffscreen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"[TinyUtil]: renderFormSync is undefined when offscreen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> imgHeight<span class="token punctuation">,</span> labelWidth <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drawFrom</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> formItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>imgHeight <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> imgHeight<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drawFrom</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> formItems<span class="token punctuation">,</span> labelWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>canvas <span class="token keyword">as</span> HTMLCanvasElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">public</span> <span class="token function">resetHeight</span><span class="token punctuation">(</span><span class="token parameter">height<span class="token operator">?</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> height <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">drawFrom</span><span class="token punctuation">(</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
    <span class="token literal-property property">formItems</span><span class="token operator">:</span> IFormItem<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    _labelWidth<span class="token operator">?</span><span class="token operator">:</span> number
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">imgHeight</span><span class="token operator">:</span> number<span class="token punctuation">;</span> labelWidth<span class="token operator">:</span> number <span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drawBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最长标签宽度</span>
    <span class="token keyword">let</span> labelWidth <span class="token operator">=</span> _labelWidth <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_labelWidth<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      formItems<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> label <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token operator">?.</span><span class="token function">measureText</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>label <span class="token operator">+</span> <span class="token string">"："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>labelWidth <span class="token operator">=</span> label<span class="token operator">?.</span>width<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>label<span class="token operator">?.</span>width <span class="token operator">&amp;&amp;</span> label<span class="token operator">?.</span>width <span class="token operator">></span> labelWidth<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          labelWidth <span class="token operator">=</span> label<span class="token operator">?.</span>width<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> nextTop <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> padding <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token comment">// 题注</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token operator">!</span><span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bold </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontSize<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">px </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontFamily<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> titleHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drawText</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token literal-property property">top</span><span class="token operator">:</span> nextTop <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontSize<span class="token operator">!</span><span class="token punctuation">,</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width <span class="token operator">-</span> padding<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nextTop <span class="token operator">+=</span> titleHeight <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontSize<span class="token operator">!</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">// 表单</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token operator">!</span><span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontSize<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">px </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontFamily<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    formItems<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> labelLeft <span class="token operator">=</span> padding <span class="token operator">+</span> labelWidth <span class="token operator">-</span> item<span class="token punctuation">.</span>labelWidth<span class="token operator">!</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> labelTop <span class="token operator">=</span> nextTop <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontSize<span class="token operator">!</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token operator">?.</span><span class="token function">fillText</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>label <span class="token operator">+</span> <span class="token string">"："</span><span class="token punctuation">,</span> labelLeft<span class="token punctuation">,</span> labelTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> contentHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drawText</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> padding <span class="token operator">+</span> labelWidth<span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> labelTop<span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> padding <span class="token operator">-</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>labelWidth<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nextTop <span class="token operator">+=</span> contentHeight <span class="token operator">+</span> padding<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">imgHeight</span><span class="token operator">:</span> nextTop<span class="token punctuation">,</span> labelWidth <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">drawText</span><span class="token punctuation">(</span>text<span class="token operator">:</span> string<span class="token punctuation">,</span> textOptions<span class="token operator">?</span><span class="token operator">:</span> ITextOptions<span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> indexStart <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token literal-property property">lines</span><span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> indexEnd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> indexEnd <span class="token operator">&lt;=</span> text<span class="token punctuation">.</span>length<span class="token punctuation">;</span> indexEnd<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> str <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>indexStart<span class="token punctuation">,</span> indexEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> measureText <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token operator">?.</span><span class="token function">measureText</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 换行</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>measureText<span class="token operator">?.</span>width<span class="token operator">!</span> <span class="token operator">></span> textOptions<span class="token operator">?.</span>width<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        lines<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>indexStart<span class="token punctuation">,</span> indexEnd <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        indexStart <span class="token operator">=</span> indexEnd <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 最后一个字符</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>indexEnd <span class="token operator">===</span> text<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        lines<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>indexStart<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">let</span> top <span class="token operator">=</span> textOptions<span class="token operator">?.</span>top<span class="token punctuation">;</span>
    lines<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">line<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      top <span class="token operator">=</span> textOptions<span class="token operator">?.</span>top<span class="token operator">!</span> <span class="token operator">+</span> index <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontSize<span class="token operator">!</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token operator">?.</span><span class="token function">fillText</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> textOptions<span class="token operator">?.</span>left<span class="token operator">!</span><span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> height <span class="token operator">=</span> top<span class="token operator">!</span> <span class="token operator">-</span> textOptions<span class="token operator">?.</span>top<span class="token operator">!</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontSize<span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> height<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">private</span> <span class="token function">drawBackground</span><span class="token punctuation">(</span><span class="token parameter">backgroundColor<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// background</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token operator">!</span><span class="token punctuation">.</span>fillStyle <span class="token operator">=</span>
      backgroundColor <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>backgroundColor <span class="token operator">||</span> <span class="token string">"#FFF"</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// recover font</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token operator">!</span><span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontSize<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">px </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontFamily<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token operator">!</span><span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>fontColor<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="worker-js"><a href="#worker-js" class="headerlink" title="worker.js"></a>worker.js</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/* eslint-disable @typescript-eslint/naming-convention */</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span>TinyCanvas<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./tiny-util.umd.cjs'</span>
<span class="token keyword">const</span> CanvasCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>sessionId<span class="token punctuation">,</span> tasks<span class="token punctuation">&#125;</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>data
  tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> placeholder <span class="token operator">=</span> <span class="token keyword">typeof</span> e<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">:</span> e<span class="token punctuation">.</span>data
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>caption<span class="token punctuation">,</span> formCfg<span class="token punctuation">,</span> columns <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">&#125;</span> <span class="token operator">=</span> placeholder
    <span class="token keyword">let</span> canvasInstance <span class="token operator">=</span> CanvasCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>columns<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>canvasInstance<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> tinyCanvasOptions <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">isOffscreen</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">635</span> <span class="token operator">/</span> columns<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">152</span> <span class="token operator">-</span> <span class="token punctuation">(</span>columns <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">fontSize</span><span class="token operator">:</span> <span class="token number">16</span> <span class="token operator">-</span> <span class="token punctuation">(</span>columns <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">'#F4F4F5'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">fontColor</span><span class="token operator">:</span> <span class="token string">'#409EFF'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">fontFamily</span><span class="token operator">:</span> <span class="token string">'serif'</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span>
      canvasInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TinyCanvas</span><span class="token punctuation">(</span>tinyCanvasOptions<span class="token punctuation">)</span>
      CanvasCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>columns<span class="token punctuation">,</span> canvasInstance<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    canvasInstance<span class="token punctuation">.</span><span class="token function">resetHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    canvasInstance
      <span class="token punctuation">.</span><span class="token function">renderForm</span><span class="token punctuation">(</span>caption<span class="token punctuation">,</span> <span class="token keyword">typeof</span> formCfg <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>formCfg<span class="token punctuation">)</span> <span class="token operator">:</span> formCfg<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
          sessionId<span class="token punctuation">,</span>
          <span class="token literal-property property">id</span><span class="token operator">:</span> e<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
          <span class="token literal-property property">extra</span><span class="token operator">:</span> e<span class="token punctuation">.</span>extra
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      <categories>
        <category>Canvas</category>
      </categories>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2023/08/24/hello-world/</url>
    <content><![CDATA[<p>本站使用博客框架 <a href="https://hexo.io/">Hexo</a> 建站，配置参考 <a href="https://zhuanlan.zhihu.com/p/618864711">Hexo+Next主题搭建个人博客+优化全过程（完整详细版）</a>.</p>
<span id="more"></span>

<h2 id="建站准备"><a href="#建站准备" class="headerlink" title="建站准备"></a>建站准备</h2><ol>
<li>域名注册：<a href="https://buy.cloud.tencent.com/domain/">腾讯云·域名注册</a></li>
<li>购买服务器：<a href="https://buy.cloud.tencent.com/lighthouse">腾讯云·轻量应用服务器</a>, 时长至少3个月(备案用)</li>
<li>域名备案：<br>a. 腾讯云备案审核：<a href="https://console.cloud.tencent.com/beian/manage">腾讯云·网站备案</a>, 请查看不同省份的备案材料需求<br>b. 管局审核：<a href="https://beian.miit.gov.cn/">ICP/IP地址/域名信息备案管理系统</a>, 若未收到短信，可再次提交（腾讯云工作人员会主动联系）<br>c. 备案成功后处理说明：<a href="https://cloud.tencent.com/document/product/243/61412#.E5.A6.82.E4.BD.95.E6.B7.BB.E5.8A.A0.E7.BD.91.E7.AB.99.E5.A4.87.E6.A1.88.E5.8F.B7.EF.BC.9F">腾讯云·备案成功后处理说明</a></li>
<li>网站添加 https: <a href="https://cloud.tencent.com/document/product/400/35244?from_cn_redirect=1">Nginx 服务器 SSL 证书安装部署</a></li>
<li>工具：<a href="https://yasuo.xunjiepdf.com/img/">图片压缩软件在线版</a></li>
</ol>
<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>枘凿六合，天下第一</title>
    <url>/2024/01/08/%E6%9E%98%E5%87%BF%E5%85%AD%E5%90%88%EF%BC%8C%E5%A4%A9%E4%B8%8B%E7%AC%AC%E4%B8%80/</url>
    <content><![CDATA[<p>【枘凿六合】是《崩坏：星穹铁道》中的一款二阶魔方解密游戏，记录 Threejs 实现过程。</p>
<img src="/2024/01/08/%E6%9E%98%E5%87%BF%E5%85%AD%E5%90%88%EF%BC%8C%E5%A4%A9%E4%B8%8B%E7%AC%AC%E4%B8%80/rzlh.gif" class="" title="枘凿六合，天下第一">

<span id="more"></span>

<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>启发来自 Threejs 的文章–<a href="https://threejs.org/manual/#zh/transparency">如何绘制透明的物体</a>，透明方块和崩铁中的透明魔方块太像了，在网上搜了一圈也没有找到模仿【枘凿六合】的例子，便想着自己实现一下。</p>
<p>不过魔方类的技术文章已经有很多实现了，如：</p>
<ul>
<li><a href="https://github.com/pancerZH/I-cannot-deal-with-Rubiks-cube">Github · I-cannot-deal-with-Rubiks-cube</a>: 使用 Three.js+Vue 编写的 3D 前端魔方游戏</li>
<li><a href="https://github.com/buuing/Rubiks-Cube">Github · Rubiks-Cube</a>: Three.js 实现魔方小游戏</li>
<li><a href="https://zhuanlan.zhihu.com/p/611744001?utm_id=0">知乎 · THREEJS 的三阶魔方</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/33580374">知乎 · ThreeJS 四步制作一个简易魔方</a>：<strong>魔方旋转</strong></li>
<li><a href="https://www.mrguo.link/article?id=23">three.js 制作魔方</a>：了解<strong>tween 的补间动画</strong></li>
</ul>
<h1 id="简化"><a href="#简化" class="headerlink" title="简化"></a>简化</h1><h2 id="美好设想"><a href="#美好设想" class="headerlink" title="美好设想"></a>美好设想</h2><p>一开始是想来个炫的，用 Blender 建模魔方块，然后用 Threejs 来渲染。</p>
<blockquote>
<p>《枘凿六合》配色硬核高雅，青灰配色为主，古色古香。相比之下传统魔方，用高饱和度单色配色，过于卡通，没有审美</p>
</blockquote>
<p>奈何技术菜，耐心差，审美挫，就用颜色方块来代替。</p>
<p>记录些视频教程链接 <del>上班时间也不敢偷偷学</del></p>
<ol>
<li><a href="https://www.bilibili.com/video/BV1zh411Y7LX/?p=2&spm_id_from=pageDriver&vd_source=1e15750346a6b797fe55bee7e478af4c">【合集 8.21 已更新 93 话】Blender 2.9-3.4 黑铁骑士 Ⅱ 系统零基础入门教程(持续更新+中文字幕+普通话+不敷衍+义务教育+案例+学习)</a></li>
<li><a href="https://juejin.cn/post/7314850529111228451">three.js 辉光的两种实现方法，及解决添加辉光后背景变成黑色的问题</a></li>
</ol>
<h2 id="冷静分析"><a href="#冷静分析" class="headerlink" title="冷静分析"></a>冷静分析</h2><p>首先，【枘凿六合】是个二阶魔方，八个方块位于空间直角坐标系的八个卦限中，投射面板位置固定且坐标系不会转动，绘制应该不成问题。</p>
<p>然后是玩家操作上，仅可选择某一个面的方块，然后“左右”转动选择的方块。</p>
<p>当同一方向上的方块和投射面满足消消乐条件时，即可获得星琼。</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="基础场景"><a href="#基础场景" class="headerlink" title="基础场景"></a>基础场景</h2><p>见文档：<a href="https://threejs.org/docs/index.html#manual/zh/introduction/Creating-a-scene">创建一个场景（Creating a scene）</a></p>
<h2 id="绘制方块"><a href="#绘制方块" class="headerlink" title="绘制方块"></a>绘制方块</h2><p>见文档：<a href="https://threejs.org/manual/#zh/transparency">如何绘制透明的物体</a></p>
<p>可按照卦限给方块编号 1~8，以配置文件的方式设置方块的颜色及附加信息，便于调整方块的颜色，构造不同关卡。<br>可附着一个 Box3 对象来标记选中时线框高亮。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 方块分类</span>
<span class="token keyword">const</span> ECubeType <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">solid</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Color</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHSL</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">hyaline</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Color</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHSL</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 方块配置</span>
<span class="token keyword">const</span> CubeCfg <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>
  <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">1.2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"octant-1"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"hyaline"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token operator">...</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建方块</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>cubeGroup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCubes</span><span class="token punctuation">(</span>CubeCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cubeGroup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="选择共面"><a href="#选择共面" class="headerlink" title="选择共面"></a>选择共面</h2><p>如何选择共面呢？</p>
<p>在崩铁中通过点击方向箭头选择共面，并添加选中效果（发光）；这里直接搞六个选择共面的按钮和左右按钮，用相对定位糊上即可。</p>
<p>如何确定选中哪些方块呢，毕竟方块是可以旋转走的？</p>
<ul>
<li><a href="https://threejs.org/docs/index.html#api/zh/helpers/Box3Helper">Box3Helper</a>：设置六个 Box3Helper 并编号，每个 Box3Helper 都能包含四个位置；使用其 Box 对象的 <a href="https://threejs.org/docs/index.html#api/zh/math/Box3.distanceToPoint">distanceToPoint</a> 方法来判断方块是否在选中的 Box3Helper 范围内，即方块是否选中。</li>
<li><a href="https://threejs.org/docs/?q=R#api/zh/core/Raycaster">Raycaster</a>：设置八条射线，可组合出六个面，通过射线相交来找选中的方块；且射线也可监测出投射面板，检查结果也更方便。</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
  * 创建射线组
  */</span>
<span class="token function">_createRaycasters</span><span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> size</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> raycasterOptions <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token comment">/**
       * 投射面: XY平面
       * 方向：Z负半轴
       */</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"raycaster-1"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> d<span class="token punctuation">,</span> d <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"solid"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token operator">...</span>
   <span class="token punctuation">]</span>
   <span class="token keyword">return</span> raycasterOptions<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建投射组</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>raycasterOptions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createRaycasters</span><span class="token punctuation">(</span>CubeCfg<span class="token punctuation">.</span>d<span class="token punctuation">,</span> CubeCfg<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 投射板</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>boardGroup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addProjectionBoard</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raycasterOptions<span class="token punctuation">,</span> CubeCfg<span class="token punctuation">.</span>d<span class="token punctuation">,</span> CubeCfg<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>boardGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 划分选择面</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>planeOptions <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"plane-1"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">raycasterIndexs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// xz,y>0</span>
        <span class="token literal-property property">rotateAxis</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">leftRad</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rightRad</span><span class="token operator">:</span> <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token operator">...</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="旋转方块"><a href="#旋转方块" class="headerlink" title="旋转方块"></a>旋转方块</h2><p>一开始调用 Object3D 的一些旋转 API（rotateOnAxis、rotateOnWorldAxis、rotateX…），结果是方块原地打转（方块各面纹理不同时可观察出来）。</p>
<p>是 Object3D 本地坐标系的原因，后来参考<a href="https://zhuanlan.zhihu.com/p/33580374">知乎 · ThreeJS 四步制作一个简易魔方</a>评论区方法，秒了。</p>
<img src="/2024/01/08/%E6%9E%98%E5%87%BF%E5%85%AD%E5%90%88%EF%BC%8C%E5%A4%A9%E4%B8%8B%E7%AC%AC%E4%B8%80/rotation.webp" class="" title="绕轴旋转">

<p>注意：这里的旋转仅仅是方块位置（看成中心点）的旋转，实际上方块旋转过程中还应该考虑自身的旋转，否则动画效果会比较怪异。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
   * @descption 旋转动画
   * @param &#123;*&#125; cubes 旋转的方块
   * @param &#123;*&#125; rotateAxis 旋转轴
   * @param &#123;*&#125; rad 旋转角度
   */</span>
  <span class="token function">_rotate</span><span class="token punctuation">(</span><span class="token parameter">cubes<span class="token punctuation">,</span> rotateAxis<span class="token punctuation">,</span> rad</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 更新起始数据</span>
    cubes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cube</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      cube<span class="token punctuation">.</span>recoardStart <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> cube<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rotation</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      cube<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      cube<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      cube<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 旋转动画</span>
    <span class="token keyword">const</span> <span class="token constant">LOCAL_AXIS</span> <span class="token operator">=</span> rotateAxis<span class="token punctuation">.</span>x <span class="token operator">?</span> <span class="token string">"x"</span> <span class="token operator">:</span> rotateAxis<span class="token punctuation">.</span>y <span class="token operator">?</span> <span class="token string">"y"</span> <span class="token operator">:</span> <span class="token string">"z"</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">TWEEN_DURATION</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tween <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TWEEN<span class="token punctuation">.</span>Tween</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">percentage</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tween<span class="token punctuation">.</span><span class="token function">easing</span><span class="token punctuation">(</span><span class="token constant">TWEEN</span><span class="token punctuation">.</span>Easing<span class="token punctuation">.</span>Quartic<span class="token punctuation">.</span>InOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tween<span class="token punctuation">.</span><span class="token function">onUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> percentage <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      cubes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cube</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 旋转面</span>
        cube<span class="token punctuation">.</span>rotation<span class="token punctuation">[</span><span class="token constant">LOCAL_AXIS</span><span class="token punctuation">]</span> <span class="token operator">=</span>
          cube<span class="token punctuation">.</span>recoardStart<span class="token punctuation">.</span>rotation<span class="token punctuation">[</span><span class="token constant">LOCAL_AXIS</span><span class="token punctuation">]</span> <span class="token operator">+</span> percentage <span class="token operator">*</span> rad<span class="token punctuation">;</span>
        <span class="token keyword">const</span> newPosition <span class="token operator">=</span> cube<span class="token punctuation">.</span>recoardStart<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newPosition<span class="token punctuation">.</span><span class="token function">applyAxisAngle</span><span class="token punctuation">(</span>rotateAxis<span class="token punctuation">,</span> percentage <span class="token operator">*</span> rad<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 旋转位置</span>
        cube<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>newPosition<span class="token punctuation">.</span>x<span class="token punctuation">,</span> newPosition<span class="token punctuation">.</span>y<span class="token punctuation">,</span> newPosition<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tween<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">/** 校验结果 */</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tween<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">percentage</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token constant">TWEEN_DURATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tween<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="胜利结算"><a href="#胜利结算" class="headerlink" title="胜利结算"></a>胜利结算</h2><p>校验结果比较简单：</p>
<ol>
<li>每条射线穿过 2 个方块和一个投射面，若满足消消乐规则，则给投射面一个高亮效果，代表成功；</li>
<li>若所有投射面都高亮，则表示关卡胜利。</li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
   * 校验结果
   */</span>
  <span class="token function">_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>raycasterOptions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> checkSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>gzsRaycaster<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> e<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> intersects <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gzsRaycaster<span class="token punctuation">.</span><span class="token function">intersectObjects</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span>children
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> intersects<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intersects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>object<span class="token punctuation">.</span>isMesh<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          checkSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>intersects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">const</span> checkArr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>checkSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      checkArr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span>
        checkArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rccs<span class="token punctuation">.</span>value <span class="token operator">===</span> checkArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rccs<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span>
          checkArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rccs<span class="token punctuation">.</span>value <span class="token operator">===</span> checkArr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rccs<span class="token punctuation">.</span>value
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>boardGroup<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> e<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>visible<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pass<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"出院！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="感言"><a href="#感言" class="headerlink" title="感言"></a>感言</h1><p>感谢知乎，感谢BiliBili，感谢无私奉献的网友。<br>一开始想做个酷酷的【枘凿六合】，但是技挫人懒，应付应付算了。<br>在旋转上找了好些方法，花了很多时间，还偷偷学《程序员的数学 · 线性代数 第一章》，未果；在参考文章的评论区发现旋转实现，真是又菜有幸运。</p>
<p>个人不看好三维的三阶魔方实用性，三阶魔方旋转更加复杂，需要更多的观察力，且玩家无法扭头切换观看角度，若再晕3D，直接人脑过载。三阶【枘凿六合】效果应该很酷，但容易把玩家玩走了。</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><blockquote>
<p>不重要：ThreeMap是基础的场景创建，自动调用 _initView。</p>
</blockquote>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 枘凿六合</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">THREE</span> <span class="token keyword">from</span> <span class="token string">"three"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">TWEEN</span> <span class="token keyword">from</span> <span class="token string">"@tweenjs/tween.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ThreeMap <span class="token keyword">from</span> <span class="token string">"./ThreeMap"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ECubeType <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">solid</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Color</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHSL</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">hyaline</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Color</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHSL</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> CubeCfg <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>
  <span class="token literal-property property">size</span><span class="token operator">:</span> <span class="token number">1.2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"octant-1"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"hyaline"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"octant-2"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"solid"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"octant-3"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"solid"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"octant-4"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"hyaline"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"octant-5"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"solid"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"octant-6"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"hyaline"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"octant-7"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"hyaline"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"octant-8"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">z</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"solid"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">GzsThreeMap</span> <span class="token keyword">extends</span> <span class="token class-name">ThreeMap</span> <span class="token punctuation">&#123;</span>
  <span class="token function">_initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addLight</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addLight</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCamera</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>far<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createRender</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rootElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createControls</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>camera<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>domElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createAxesHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">switchAnimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 相机归位</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">4.6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5.14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>camera<span class="token punctuation">.</span>up<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>camera<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建方块</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cubeGroup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCubes</span><span class="token punctuation">(</span>CubeCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cubeGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建投射组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>raycasterOptions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createRaycasters</span><span class="token punctuation">(</span>CubeCfg<span class="token punctuation">.</span>d<span class="token punctuation">,</span> CubeCfg<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 投射板</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>boardGroup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addProjectionBoard</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>raycasterOptions<span class="token punctuation">,</span>
      CubeCfg<span class="token punctuation">.</span>d<span class="token punctuation">,</span>
      CubeCfg<span class="token punctuation">.</span>size
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>boardGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 划分选择面</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>planeOptions <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"plane-1"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">raycasterIndexs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// xz,y>0</span>
        <span class="token literal-property property">rotateAxis</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">leftRad</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rightRad</span><span class="token operator">:</span> <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"plane-2"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">raycasterIndexs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// xz,y&lt;0</span>
        <span class="token literal-property property">rotateAxis</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">leftRad</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rightRad</span><span class="token operator">:</span> <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"plane-3"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">raycasterIndexs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// yz,x>0</span>
        <span class="token literal-property property">rotateAxis</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">leftRad</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rightRad</span><span class="token operator">:</span> <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"plane-4"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">raycasterIndexs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// yz,x&lt;0</span>
        <span class="token literal-property property">rotateAxis</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">leftRad</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rightRad</span><span class="token operator">:</span> <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"plane-5"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">raycasterIndexs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// xy,z>0</span>
        <span class="token literal-property property">rotateAxis</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">leftRad</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rightRad</span><span class="token operator">:</span> <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"plane-6"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">raycasterIndexs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// yz,x&lt;0</span>
        <span class="token literal-property property">rotateAxis</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">leftRad</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rightRad</span><span class="token operator">:</span> <span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 投射</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gzsRaycaster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Raycaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gzsRaycaster<span class="token punctuation">.</span>camera <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>camera<span class="token punctuation">;</span>
    <span class="token comment">// 当前选中面</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentPlane <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentMeshSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span>background <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Color</span><span class="token punctuation">(</span><span class="token string">"white"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * 动画监听
   */</span>
  <span class="token function">_animateListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token constant">TWEEN</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * 添加光照
   */</span>
  <span class="token function">_addLight</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>pos</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token number">0xffffff</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> intensity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> light <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>DirectionalLight</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    light<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    light<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">...</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>light<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * 新建立方体
   * @param &#123;*&#125; cubeCfg
   * @returns
   */</span>
  <span class="token function">_createCubes</span><span class="token punctuation">(</span><span class="token parameter">cubeCfg</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> d<span class="token punctuation">,</span> size<span class="token punctuation">,</span> options <span class="token punctuation">&#125;</span> <span class="token operator">=</span> cubeCfg<span class="token punctuation">;</span>
    <span class="token keyword">const</span> geometry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>BoxGeometry</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> size<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cubeGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    options<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 立方体</span>
      <span class="token keyword">const</span> material <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MeshPhongMaterial</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">color</span><span class="token operator">:</span> ECubeType<span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span>color<span class="token punctuation">,</span>
        <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transparent</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">side</span><span class="token operator">:</span> <span class="token constant">THREE</span><span class="token punctuation">.</span>DoubleSide<span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> cube <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Mesh</span><span class="token punctuation">(</span>geometry<span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cube<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>x <span class="token operator">*</span> d<span class="token punctuation">,</span> e<span class="token punctuation">.</span>y <span class="token operator">*</span> d<span class="token punctuation">,</span> e<span class="token punctuation">.</span>z <span class="token operator">*</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cube<span class="token punctuation">.</span>name <span class="token operator">=</span> e<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      cube<span class="token punctuation">.</span>rccs <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> ECubeType<span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token comment">// 选中效果</span>
      <span class="token keyword">const</span> box <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Box3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      box<span class="token punctuation">.</span><span class="token function">setFromCenterAndSize</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> size<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Box3Helper</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> <span class="token number">0xffff00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      helper<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      helper<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"box3Helper"</span><span class="token punctuation">;</span>
      cube<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>helper<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 触发选中效果</span>
      cube<span class="token punctuation">.</span><span class="token function-variable function">trigger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">visible</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        cube<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>visible <span class="token operator">=</span> visible<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      cubeGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cube<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cubeGroup<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * 创建射线组
   */</span>
  <span class="token function">_createRaycasters</span><span class="token punctuation">(</span><span class="token parameter">d<span class="token punctuation">,</span> size</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> raycasterOptions <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token comment">/**
       * 投射面: XY平面
       * 方向：Z负半轴
       */</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"raycaster-1"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> d<span class="token punctuation">,</span> d <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"solid"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"raycaster-2"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token operator">-</span>d<span class="token punctuation">,</span> d<span class="token punctuation">,</span> d <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"solid"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"raycaster-3"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token operator">-</span>d<span class="token punctuation">,</span> <span class="token operator">-</span>d<span class="token punctuation">,</span> d <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"hyaline"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"raycaster-4"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token operator">-</span>d<span class="token punctuation">,</span> d <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"hyaline"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token comment">/**
       * 投射面: YZ平面
       * 方向：X负半轴
       */</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"raycaster-5"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>d <span class="token operator">+</span> size<span class="token punctuation">,</span> d<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"solid"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"raycaster-6"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>d <span class="token operator">+</span> size<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token operator">-</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"solid"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"raycaster-7"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>d <span class="token operator">+</span> size<span class="token punctuation">,</span> <span class="token operator">-</span>d<span class="token punctuation">,</span> <span class="token operator">-</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"hyaline"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"raycaster-8"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>d <span class="token operator">+</span> size<span class="token punctuation">,</span> <span class="token operator">-</span>d<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"hyaline"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> raycasterOptions<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * @descption 增加投影面
   */</span>
  <span class="token function">_addProjectionBoard</span><span class="token punctuation">(</span><span class="token parameter">raycasterOptions<span class="token punctuation">,</span> d<span class="token punctuation">,</span> size</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> boardGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    raycasterOptions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> dx <span class="token operator">=</span> e<span class="token punctuation">.</span>direction<span class="token punctuation">.</span>x <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0.1</span> <span class="token operator">:</span> size<span class="token punctuation">;</span>
      <span class="token keyword">const</span> dy <span class="token operator">=</span> size<span class="token punctuation">;</span>
      <span class="token keyword">const</span> dz <span class="token operator">=</span> e<span class="token punctuation">.</span>direction<span class="token punctuation">.</span>z <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0.1</span> <span class="token operator">:</span> size<span class="token punctuation">;</span>
      <span class="token keyword">const</span> geometry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>BoxGeometry</span><span class="token punctuation">(</span>
        e<span class="token punctuation">.</span>direction<span class="token punctuation">.</span>x <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0.1</span> <span class="token operator">:</span> size<span class="token punctuation">,</span>
        size<span class="token punctuation">,</span>
        e<span class="token punctuation">.</span>direction<span class="token punctuation">.</span>z <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0.1</span> <span class="token operator">:</span> size
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> material <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MeshPhongMaterial</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">color</span><span class="token operator">:</span> ECubeType<span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span>color<span class="token punctuation">,</span>
        <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">0.6</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transparent</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">side</span><span class="token operator">:</span> <span class="token constant">THREE</span><span class="token punctuation">.</span>DoubleSide<span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> board <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Mesh</span><span class="token punctuation">(</span>geometry<span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
      board<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
        e<span class="token punctuation">.</span>direction<span class="token punctuation">.</span>x <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token operator">-</span>e<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>x <span class="token operator">:</span> e<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
        e<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        e<span class="token punctuation">.</span>direction<span class="token punctuation">.</span>z <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token operator">-</span>e<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>z <span class="token operator">:</span> e<span class="token punctuation">.</span>origin<span class="token punctuation">.</span>z
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      board<span class="token punctuation">.</span>rccs <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> ECubeType<span class="token punctuation">[</span>e<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token comment">// 检查效果</span>
      <span class="token keyword">const</span> box <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Box3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      box<span class="token punctuation">.</span><span class="token function">setFromCenterAndSize</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">,</span> dz<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Box3Helper</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> <span class="token number">0xffff00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      helper<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      helper<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"box3Helper"</span><span class="token punctuation">;</span>
      board<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>helper<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 触发通过效果</span>
      board<span class="token punctuation">.</span><span class="token function-variable function">trigger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">visible</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        board<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>visible <span class="token operator">=</span> visible<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      boardGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>board<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> boardGroup<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * 按面选择
   * @param &#123;*&#125; name
   */</span>
  <span class="token function">selectFrame</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> planeName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">plane-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentPlane <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>planeOptions<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> e<span class="token punctuation">.</span>name <span class="token operator">===</span> planeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentMeshSet<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cubeGroup<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      e<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentPlane<span class="token punctuation">.</span>raycasterIndexs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> origin<span class="token punctuation">,</span> direction <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raycasterOptions<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>gzsRaycaster<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> intersects <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gzsRaycaster<span class="token punctuation">.</span><span class="token function">intersectObjects</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cubeGroup<span class="token punctuation">.</span>children
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> intersects<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intersects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>object<span class="token punctuation">.</span>isMesh<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>currentMeshSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>intersects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentMeshSet<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      e<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">rotateLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_rotate</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currentMeshSet<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currentPlane<span class="token punctuation">.</span>rotateAxis<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currentPlane<span class="token punctuation">.</span>leftRad
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">rotateRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_rotate</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currentMeshSet<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currentPlane<span class="token punctuation">.</span>rotateAxis<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>currentPlane<span class="token punctuation">.</span>rightRad
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * @descption 旋转动画
   * @param &#123;*&#125; cubes 旋转的方块
   * @param &#123;*&#125; rotateAxis 旋转轴
   * @param &#123;*&#125; rad 旋转角度
   */</span>
  <span class="token function">_rotate</span><span class="token punctuation">(</span><span class="token parameter">cubes<span class="token punctuation">,</span> rotateAxis<span class="token punctuation">,</span> rad</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 更新起始数据</span>
    cubes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cube</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      cube<span class="token punctuation">.</span>recoardStart <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> cube<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rotation</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      cube<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      cube<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      cube<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 旋转动画</span>
    <span class="token keyword">const</span> <span class="token constant">LOCAL_AXIS</span> <span class="token operator">=</span> rotateAxis<span class="token punctuation">.</span>x <span class="token operator">?</span> <span class="token string">"x"</span> <span class="token operator">:</span> rotateAxis<span class="token punctuation">.</span>y <span class="token operator">?</span> <span class="token string">"y"</span> <span class="token operator">:</span> <span class="token string">"z"</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">TWEEN_DURATION</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tween <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TWEEN<span class="token punctuation">.</span>Tween</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">percentage</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tween<span class="token punctuation">.</span><span class="token function">easing</span><span class="token punctuation">(</span><span class="token constant">TWEEN</span><span class="token punctuation">.</span>Easing<span class="token punctuation">.</span>Quartic<span class="token punctuation">.</span>InOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tween<span class="token punctuation">.</span><span class="token function">onUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> percentage <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      cubes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cube</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 旋转面</span>
        cube<span class="token punctuation">.</span>rotation<span class="token punctuation">[</span><span class="token constant">LOCAL_AXIS</span><span class="token punctuation">]</span> <span class="token operator">=</span>
          cube<span class="token punctuation">.</span>recoardStart<span class="token punctuation">.</span>rotation<span class="token punctuation">[</span><span class="token constant">LOCAL_AXIS</span><span class="token punctuation">]</span> <span class="token operator">+</span> percentage <span class="token operator">*</span> rad<span class="token punctuation">;</span>
        <span class="token keyword">const</span> newPosition <span class="token operator">=</span> cube<span class="token punctuation">.</span>recoardStart<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newPosition<span class="token punctuation">.</span><span class="token function">applyAxisAngle</span><span class="token punctuation">(</span>rotateAxis<span class="token punctuation">,</span> percentage <span class="token operator">*</span> rad<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 旋转位置</span>
        cube<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>newPosition<span class="token punctuation">.</span>x<span class="token punctuation">,</span> newPosition<span class="token punctuation">.</span>y<span class="token punctuation">,</span> newPosition<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tween<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">/** 校验结果 */</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tween<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">percentage</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token constant">TWEEN_DURATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tween<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/**
   * 校验结果
   */</span>
  <span class="token function">_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>raycasterOptions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> checkSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>gzsRaycaster<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> e<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> intersects <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gzsRaycaster<span class="token punctuation">.</span><span class="token function">intersectObjects</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scene<span class="token punctuation">.</span>children
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> intersects<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intersects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>object<span class="token punctuation">.</span>isMesh<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          checkSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>intersects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">const</span> checkArr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>checkSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
      checkArr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span>
        checkArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rccs<span class="token punctuation">.</span>value <span class="token operator">===</span> checkArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rccs<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span>
          checkArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rccs<span class="token punctuation">.</span>value <span class="token operator">===</span> checkArr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rccs<span class="token punctuation">.</span>value
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>boardGroup<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> e<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>visible<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pass<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"出院！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      <categories>
        <category>Threejs</category>
      </categories>
  </entry>
</search>
